<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>WorkFlow Designer</title>
    <!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="css/main.css" rel="stylesheet" media="screen">
 </head>
    <body>
    <div id="sideBar"></div>
	<div id="toolBar" class="section_header" style="margin-top:50px;margin-left:20px;width:1000px;height:50px;">
		 <div class="userSelect icon"></div>
		 <!--img id="select" class="icon unselected" src="images/select.gif" style=""></img-->
		 <img id="participant" title="参与者" class="icon unselected" src="images/participantrole.png"></img>
		 <img id="default_participant" title="任意参与者" class="icon unselected" src="images/freetextparticipant.png"></img>
		 <img id="start" title="开始" class="icon unselected" src="images/start.png"></img>
		 <img id="end" title="结束" class="icon unselected" src="images/end.png"></img>
		 <img id="voidnode" title="空活动" class="icon unselected" src="images/genericactivity.png"></img>
		 
		 <img id="autoactivity" title="自动活动" class="icon unselected" src="images/autoactivity.png"></img>
		 <img id="humantaskactivity" title="人工活动" class="icon unselected" src="images/humantaskactivity.png"></img>
		 <img id="businessactivity" title="业务活动" class="icon unselected" src="images/activitytask.png"></img>
		 <img id="blockactivity" class="icon unselected" src="images/blockactivity.png"></img>
		 <img id="routesplitactivity" class="icon unselected" src="images/route_split_activity.png"></img>
		 <img id="routejoinactivity" class="icon unselected" src="images/route_join_activity.png"></img>
		 <img id="redo" class="icon unselected" src="images/redo.png"></img>
		 
		 <img id="undo" class="icon unselected" src="images/undo.png" style="left:100px"></img>
		 <img id="unCondition_transition" class="icon unselected" src="images/transition.png" style="left:150px"></img>
		 <!--img id="zoomout" class="icon unselected" src="images/zoomout.png" style="left:200px"></img-->
		 <!--div class="move unselected" style="background-image:url(images/zoomout.png)"-->
		 <button class="btn save btn-primary"  data-loading-text="正在保存">保存</button>
		 <button class="btn dialog btn-primary"  data-loading-text="正在打开">绑定表单</button>
		 <div class="btn-group menu">
	        <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">文件 <span class="caret"></span></button>
	        <ul class="dropdown-menu">
	          <li><a href="#" class="checkOrder">检验</a></li>
	          <li><a href="#" class="saveOreder">保存</a></li>
	          <li><a href="#" class="importOrder">导入</a></li>
	          <li><a href="#" class="quit">退出</a></li>
	        </ul>
         </div>
         <div class="btn-group application">
            <button class="btn dropdown-toggle" data-toggle="dropdown">绑定应用<span class="caret"></span></button>
            <ul class="dropdown-menu">
              <li><a href="#" class="formApp">Form</a></li>
              <li><a href="#" class="scriptApp">Script</a></li>
            </ul>
          </div>
	</div>
	<div id="container" class="box" style="margin-top:0px;margin-left:20px;width:1000px;height:255px;">
	</div>
		<!-- 容器结束，对话框开始 -->
		<div class="modal hide fade in" id="new_course_dialog" style="width:700px;margin-left:-350px">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
			<h3>流程定义</h3>
		  </div>
		  <div class="modal-body">
			<ul class="nav nav-tabs">
  			<li class="temple active">
    			<a href="#">活动</a>
  			</li>
  			<li class="temple">
    			<a href="#">属性</a>
  			</li>
			</ul>
			<div id="content"></div>
		  </div>
		  <div class="modal-footer">
		  </div>
		</div>
</body>
<script language="javascript" type="text/javascript" src="jquery/jquery-1.9.1.js"></script>
<script src="jquery-ui/jquery-ui.js"></script>
<script src="jsplumb/jquery.jsPlumb-1.5.5.js"></script>
<script src="js/init.js"></script>
<script src="js/process_xml.js"></script>
<script src="js/constructor.js"></script>
<script src="js/register.js"></script>
<script src="js/ActivityDialog.js"></script>
<script src="bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<script src="js/Model.js"></script>
<script src="js/controller.js"></script>
<script src="js/setPosition.js"></script>
<script type="text/javascript">
function getFrom(){
	return $("#toolBar").data("from");
}
function getTo(){
	return $("#toolBar").data("to");
}
function setFrom(from){
	$("#toolBar").data("from",from);
}
function setTo(to){
	$("#toolBar").data("to",to);
}
function appendNewElement(container,ui){
		var incoming=ui.helper.context.id;
		var new_element=$('<img>').attr("src",ui.helper.context.src).addClass("dropped").addClass("unselected");
		var num_y=$(container).css("height").match(/\d*/);
		var parent=null;
		var arr=$("#container").data("w").participants || [];
		var name="";
		var new_container=null;
		var off_y=(num_y[0])*(arr.length-1)+119+10*(arr.length-1);
		var index=0;
		//var name_index=0;
		var span=$("<span>").css({
			position:'absolute',
			display:'none'
		});
		index=$("#container").data(incoming);
		if(incoming!="default_participant"){
			name=incoming+""+index;
		}else{
			name=incoming;
		}
		//name_index=name.indexOf('activity');
		// if(name_index>=0){
		// 	//name=name.substr(name_index);
		// }
		// //span.html(name);
		if(incoming!="participant" && incoming!="default_participant"){
				parent=$('<div>').css({
					position:'absolute',
					left:ui.offset.left,
					top:ui.offset.top
				})
				span.css({
					left:0,
					top:32,
					width:50
				});
		}else{
				parent=$('<div>').css({
					position:'absolute',
					left:27,
					top:off_y,
				});
				
				span.css({
					left:0,
					top:32,
					width:50
				});
		}
		new_element.attr("title",name);
		new_element.appendTo(parent);
		span.appendTo(parent);//要想修改它的位置要在append操作之后修改
		parent.attr("id",name).addClass("dropped");
		//双击图标事件
		parent.bind("dblclick",function(){
			$(".dialog").trigger("click",[$(this)]);
		});
		if(new_container=addNewLine(container,incoming)){
			parent.appendTo(new_container);
		}else{		
			parent.appendTo(container);
		}
		jsPlumb.draggable(parent,{revert: "invalid",
			stop:function(e){
				//console.log($(e.target).attr("id"));
			}
		});
		var stateMachineConnector=$("#toolBar").data("option");
		parent.bind("click",function(){
			if($("#unCondition_transition").hasClass("unselected")){
				return;
			}
			if(!getFrom() && !getTo()){
				setFrom($(this).attr("id"));
			}else if(getFrom() && !getTo()){
				setTo($(this).attr("id"));
				createTransition(getFrom(),getTo(),stateMachineConnector);
			}
		});			
};
function createTransition(from,to,stateMachineConnector){
	var come=from;
	var go=to;
	if(come===go){
		setFrom(null);
		setTo(null);
		return;
	}
	var connect=null;
	var num=$("#container").data("transition")|| 0;
	num++;
	$("#container").data("transition",num);
	connect=jsPlumb.connect({
			source:come,
			target:go,
	},stateMachineConnector);
	connect.setLabel({ cssClass:"component label",label:num+"", location:0.5 });
	if(from.indexOf("start")<0 && to.indexOf("end")<0){					
			$("#container").trigger("transition",[from,to]);
	}else if(from.indexOf("start")>=0){
		$("#container").data("w").start.connecting=to;
	}else if(to.indexOf("end")>=0){
		$("#container").data("w").end.connecting=from;
	}
	//将起点和终点恢复成空值
	setFrom(null);
	setTo(null);
	connect.bind("dblclick", function(conn) {
			$('#new_course_dialog').data('tran',conn);
			$('#new_course_dialog').modal('show');
			//jsPlumb.detach(conn);
	});
	return connect;
}
function trigger(container,str,performer){
	var _this=$(container);
	var num=$("#container").data(str)|| 0;
	num++;
	$("#container").data(str,num);
	if(str.indexOf("activity")>0 && str.indexOf("route")==-1){
		_this.trigger("activity",[str,performer]);
	}else if(str.indexOf("route")>=0 || (str=='start' || str=='end')){
		_this.trigger(str,[str,performer]);
	}else{
		_this.trigger(str);
	}
}
function addNewLine(current,incoming){
	if($("#container").data("w").participants.length>1 && (incoming=="participant" || incoming=="default_participant")){
		var line=$(current).clone();
		line.find("div.dropped").remove();
		var opt=$(current).droppable("option");
		var index=$("#container").data(incoming);
		line.attr("id","container"+index);
		line.addClass("line");
		line.droppable(opt);
		//console.log(opt);
		var index=$("div[id*='container']").length-1;
		var pre=$("div[id*='container']:eq("+index+")");
		//console.log(pre);
		line.insertAfter(pre);
		return line;
	}else{
		return null;
	}
}
function fillInOffsetForElements(){

}
$(document).keydown(function(e){
	if(e.which==46){
		//console.log("删除节点了啊");
	}    
});  
	jsPlumb.bind("ready", function() {
		document.onselectstart = function () { return false; };	
		jsPlumbDemo.init();
		var icons=$("#toolBar").find(".icon");
		var stateMachineConnector=$("#toolBar").data("option");
		icons.each(function(index,el){
			 $(el).bind("click",function(){
			 	//$(icons).removeClass("selected");
			 	//$(icons).addClass("unselected");
			 	$(this).siblings().find(".icon").removeClass("selected");
			 	$(this).siblings().find(".icon").addClass("unselected");
			 	if($(this).hasClass("selected")){
			 		$(this).removeClass("selected");
			 		$(this).addClass("unselected");			
			 	}else{
			 		$(this).removeClass("unselected");
			 		$(this).addClass("selected");		
			 	}
			 	//针对连接操作做特殊设置
			 	if($(this).attr("id")=="unCondition_transition"){
			 		setFrom(null);
					setTo(null);
					if($(this).hasClass("selected")){
						$("div[id*='container']").find("div.dropped").draggable("disable");
					}else{
						$("div[id*='container']").find("div.dropped").draggable("enable");
					}					
			 	}					 	
		 	 });
		});
		$(".dialog").bind("click",function(e,obj){
			$('#new_course_dialog').data("obj",obj);
			$('#new_course_dialog').modal("show");
		});
		$("#participant").draggable({helper:"clone"});
		$("#default_participant").draggable({helper:"clone"});
		$("#container").droppable({
			drop:function(event,ui){
				var incoming=ui.helper.context.id;
				if(!$("#container").data("w").participants || $("#container").data("w").participants.length==0){
					if(incoming!="participant" && incoming!="default_participant"){
						return;
					}else{
						$( ".icon" ).draggable({helper:"clone"});
					}
				}
				var str=ui.helper.context.className;
				if(str.indexOf("dropped")>=0){
					return;
				}
				var performer=$(this).find("div[id*='participant']").attr("id");
				trigger($("#container"),incoming,performer);
				appendNewElement($(this),ui);
			},
		});
	function formatXml(str){
		str = str.replace(/[ <\/]\w/g,function(s){
			//console.log(s.toLocaleUpperCase());
			//var c=str.match(/\w/);
			//console.log(c[0]);
			return s.toLocaleUpperCase();
		});
		str =str.replace(/ _\w/g,function(s){
			//console.log(s);
			return s.substring(1,2);
		});
		return str;
	}
	$(".save").bind("click",function(){
		//将图标的位置填写到各个对象中
		setPosition();
		var tmp=$("#container").data("w").getXml();
		//console.log(tmp[0]);
		var pac=$("#container").data("p");
		//对package对象进行初始化，清空已经添加的workflow对象
		pac.find("Workflow_Process").remove();
		tmp.appendTo(pac);
		var test=$("<test>");
		pac.appendTo(test);
		//$("<test>").append($("#container").data("w").getXml());
		//console.log(pac[0]);
		var str=test.html();
		//标签首字母大写
		str = str.replace(/[ <\/]\w/g,function(s){
			//console.log(s.toLocaleUpperCase());
			//var c=str.match(/\w/);
			//console.log(c[0]);
			return s.toLocaleUpperCase();
		});
		//某一些不需要大写的属性保持原样
		str =str.replace(/ _\w/g,function(s){
			//console.log(s);
			return s.substring(1,2);
		});
		//恢复驼峰是命名的大小写情况
		str =str.replace(/\w_(\w)/g,function(s,b){
			if(b < 'a'){
				return s;
			}else{
				return s.substring(0,1)+b.toUpperCase();
			}
		});
		//XPDLVersion标签的特殊情况
		str =str.replace(/Xpdlv/g,function(s){
			return s.toUpperCase();
		})
		//console.log(str);
		var data1={"processdefinition":str};
		$.ajax({
			//url: "http://127.0.0.1:8080/HiServiceCRM/checkProcessDefinition.action",
			url:"http://127.0.0.1:8080/struts2_demo/XmlString.action",
     		type: "POST",
     		//data: {"json":JSON.stringify(data1)},
     		data:{"xml":data1.processdefinition},
     		success:function(data){
     			console.log(data);
     		},
         });
	});
});

</script>
</html>
